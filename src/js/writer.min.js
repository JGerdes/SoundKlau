//from https://github.com/egoroof/browser-id3-writer
!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?exports.ID3Writer=r():e.ID3Writer=r()}(this,function(){return function(e){function r(n){if(t[n])return t[n].exports;var a=t[n]={exports:{},id:n,loaded:!1};return e[n].call(a.exports,a,a.exports,r),a.loaded=!0,a.exports}var t={};return r.m=e,r.c=t,r.p="",r(0)}([function(e,r){"use strict";function t(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function n(e){for(var r=[],t=255,n=24;n>=0;n-=8)r.push(e>>>n&t);return r}function a(e){for(var r=[],t=127,n=21;n>=0;n-=7)r.push(e>>>n&t);return r}function i(e){for(var r=0,t=0,n=21;n>=0;n-=7,t++)r+=e[t]<<n;return r}function s(e){return e.join("/")||"Unknown Artist"}function u(e){return e.join(";")}function o(e){var r=0;return e.forEach(function(e){r+=e.size}),r}function f(e){var r=10,t=1;return r+t+e}function c(e){var r=10,t=1,n=2,a=2*e;return r+t+n+a}function h(e){var r=10,t=1,n=3,a=2,i=2*e;return r+t+n+a+i}function l(e,r){var t=10,n=1,a=1,i=1;return t+n+r+a+i+a+e}function g(e){if(!e||!e.length)return null;if(255===e[0]&&216===e[1]&&255===e[2])return"image/jpeg";if(137===e[0]&&80===e[1]&&78===e[2]&&71===e[3])return"image/png";if(71===e[0]&&73===e[1]&&70===e[2])return"image/gif";if(87===e[8]&&69===e[9]&&66===e[10]&&80===e[11])return"image/webp";var r=73===e[0]&&73===e[1]&&42===e[2]&&0===e[3],t=77===e[0]&&77===e[1]&&0===e[2]&&42===e[3];return r||t?"image/tiff":66===e[0]&&77===e[1]?"image/bmp":0===e[0]&&0===e[1]&&1===e[2]&&0===e[3]?"image/x-icon":null}var y=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),v=function(){function e(r){if(t(this,e),!r||r.constructor!==ArrayBuffer)throw new Error("First argument should be an instance of ArrayBuffer");var n=new Uint8Array(r,0,3),a=255===n[0]&&251===n[1],i=73===n[0]&&68===n[1]&&51===n[2];if(!a&&!i)throw new Error("ArrayBuffer is not an mp3 file or it is corrupted");this.arrayBuffer=r,this.padding=4096,this.frames=[],this.url=""}return y(e,[{key:"_setIntegerFrame",value:function(e,r){var t=parseInt(r,10);this.frames.push({name:e,value:t,size:f(t.toString().length)})}},{key:"_setStringFrame",value:function(e,r){var t=r.toString();this.frames.push({name:e,value:t,size:c(t.length)})}},{key:"_setPictureFrame",value:function(e,r){var t=g(new Uint8Array(r),0,12);if(!t)throw new Error("Unknown picture MIME type");this.frames.push({name:e,value:r,mimeType:t,size:l(r.byteLength,t.length)})}},{key:"_setLyricsFrame",value:function(e,r){var t=r.toString();this.frames.push({name:e,value:t,size:h(t.length)})}}]),y(e,[{key:"setFrame",value:function(e,r){switch(e){case"TPE1":case"TCOM":if(!Array.isArray(r))throw new Error(e+" frame value should be an array of strings");var t=r.map(function(e){return e.toString()}),n=s(t);this._setStringFrame(e,n);break;case"TCON":if(!Array.isArray(r))throw new Error(e+" frame value should be an array of strings");var a=r.map(function(e){return e.toString()}),i=u(a);this._setStringFrame(e,i);break;case"TIT2":case"TALB":case"TPE2":case"TRCK":case"TPOS":case"TPUB":this._setStringFrame(e,r);break;case"TLEN":case"TYER":this._setIntegerFrame(e,r);break;case"USLT":this._setLyricsFrame(e,r);break;case"APIC":if(r.constructor!==ArrayBuffer)throw new Error("APIC frame value should be an instance of ArrayBuffer");this._setPictureFrame(e,r);break;default:throw new Error("Unsupported frame "+e)}return this}},{key:"removeTag",value:function(){var e=10,r=this.arrayBuffer.byteLength;if(!(e>r)){var t=new Uint8Array(this.arrayBuffer,0,e),n=73===t[0]&&68===t[1]&&51===t[2];if(n){var a=t[3];if(!(2>a||a>4)){var s=i([t[6],t[7],t[8],t[9]]);this.arrayBuffer=this.arrayBuffer.slice(s+e)}}}}},{key:"addTag",value:function(){this.removeTag();var e=0,r=10,t=o(this.frames),i=r+t+this.padding,s=new ArrayBuffer(this.arrayBuffer.byteLength+i),u=new Uint8Array(s),f=new TextEncoder("utf-8"),c=new TextEncoder("utf-16le"),h=[73,68,51,3];return u.set(h,e),e+=h.length,e++,e++,h=a(i-r),u.set(h,e),e+=h.length,this.frames.forEach(function(t){switch(h=f.encode(t.name),u.set(h,e),e+=h.length,h=n(t.size-r),u.set(h,e),e+=h.length,e+=2,t.name){case"TPE1":case"TCOM":case"TCON":case"TIT2":case"TALB":case"TPE2":case"TRCK":case"TPOS":case"TPUB":h=[1,255,254],u.set(h,e),e+=h.length,h=c.encode(t.value),u.set(h,e),e+=h.length;break;case"USLT":var a=[101,110,103];h=[1].concat(a),u.set(h,e),e+=h.length,e+=2,h=c.encode(t.value),u.set(h,e),e+=h.length;break;case"TLEN":case"TYER":e++,h=f.encode(t.value),u.set(h,e),e+=h.length;break;case"APIC":e++,h=f.encode(t.mimeType),u.set(h,e),e+=h.length,h=[0,3,0],u.set(h,e),e+=h.length,u.set(new Uint8Array(t.value),e),e+=t.value.byteLength}}),e+=this.padding,u.set(new Uint8Array(this.arrayBuffer),e),this.arrayBuffer=s,s}},{key:"getBlob",value:function(){return new Blob([this.arrayBuffer],{type:"audio/mpeg"})}},{key:"getURL",value:function(){return this.url||(this.url=URL.createObjectURL(this.getBlob())),this.url}},{key:"revokeURL",value:function(){URL.revokeObjectURL(this.url)}}]),e}();e.exports=v}])});